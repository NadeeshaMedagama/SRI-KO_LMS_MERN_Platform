<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .debug-info { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Admin Dashboard Debug Tool</h1>
        
        <div class="test-section info">
            <h3>üìã Debug Information</h3>
            <div class="debug-info">
                <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
                <p><strong>Frontend Port:</strong> <span id="frontendPort"></span></p>
                <p><strong>API Base URL:</strong> <span id="apiBaseUrl"></span></p>
                <p><strong>Token in localStorage:</strong> <span id="tokenStatus"></span></p>
                <p><strong>Admin Token in localStorage:</strong> <span id="adminTokenStatus"></span></p>
            </div>
        </div>

        <div class="test-section">
            <h3>üîê Step 1: Test Admin Login</h3>
            <button onclick="testAdminLogin()">Test Admin Login</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>üìä Step 2: Test Dashboard Stats</h3>
            <button onclick="testDashboardStats()">Test Dashboard Stats</button>
            <div id="statsResult"></div>
        </div>

        <div class="test-section">
            <h3>üë• Step 3: Test Recent Users</h3>
            <button onclick="testRecentUsers()">Test Recent Users</button>
            <div id="usersResult"></div>
        </div>

        <div class="test-section">
            <h3>üìö Step 4: Test Recent Courses</h3>
            <button onclick="testRecentCourses()">Test Recent Courses</button>
            <div id="coursesResult"></div>
        </div>

        <div class="test-section">
            <h3>üåê Step 5: Test Frontend-Backend Connection</h3>
            <button onclick="testConnection()">Test Connection</button>
            <div id="connectionResult"></div>
        </div>

        <div class="test-section">
            <h3>üîç Step 6: Browser Console Check</h3>
            <p>Open browser console (F12) and check for any errors when loading the admin dashboard.</p>
            <button onclick="simulateDashboardLoad()">Simulate Dashboard Load</button>
            <div id="consoleResult"></div>
        </div>

        <div class="test-section">
            <h3>üí° Potential Issues & Solutions</h3>
            <div id="issuesList"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        
        // Auto-detect API URL like the frontend does
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isDevelopment = window.location.port === '5173' || window.location.port === '5174' || window.location.port === '5175' || window.location.port === '5178';
        const API_BASE = (isLocalhost && isDevelopment) 
            ? 'http://localhost:5000'  
            : 'https://bfdef01f-7fc1-46ea-af69-42279e15f710-dev.e1-us-east-azure.choreoapis.dev/sri-ko-lms-platform/backend/v1';

        function updateDebugInfo() {
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('frontendPort').textContent = window.location.port;
            document.getElementById('apiBaseUrl').textContent = API_BASE;
            document.getElementById('tokenStatus').textContent = localStorage.getItem('token') ? 'Yes' : 'No';
            document.getElementById('adminTokenStatus').textContent = localStorage.getItem('adminToken') ? 'Yes' : 'No';
        }

        async function testAdminLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '<p>Testing admin login...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/admin-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@sriko.com',
                        password: 'Admin123'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('adminToken', data.token);
                    localStorage.setItem('adminUser', JSON.stringify(data.user));
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Login Successful!</h4>
                            <p><strong>User:</strong> ${data.user.name} (${data.user.email})</p>
                            <p><strong>Role:</strong> ${data.user.role}</p>
                            <p><strong>Token:</strong> ${data.token.substring(0, 50)}...</p>
                        </div>
                    `;
                    updateDebugInfo();
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Login Failed</h4>
                            <p>${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Login Error</h4>
                        <p>${error.message}</p>
                        <p><strong>Possible causes:</strong></p>
                        <ul>
                            <li>Backend server not running on port 5000</li>
                            <li>CORS issues</li>
                            <li>Network connectivity problems</li>
                        </ul>
                    </div>
                `;
            }
        }

        async function testDashboardStats() {
            const resultDiv = document.getElementById('statsResult');
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="error"><p>Please login first!</p></div>';
                return;
            }

            resultDiv.innerHTML = '<p>Fetching dashboard stats...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/stats`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Stats Retrieved!</h4>
                            <pre>${JSON.stringify(data.stats, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Stats Failed</h4>
                            <p>${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Stats Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testRecentUsers() {
            const resultDiv = document.getElementById('usersResult');
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="error"><p>Please login first!</p></div>';
                return;
            }

            resultDiv.innerHTML = '<p>Fetching recent users...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/users?limit=5`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Users Retrieved!</h4>
                            <p><strong>Count:</strong> ${data.count} users</p>
                            <pre>${JSON.stringify(data.users.slice(0, 3), null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Users Failed</h4>
                            <p>${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Users Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testRecentCourses() {
            const resultDiv = document.getElementById('coursesResult');
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="error"><p>Please login first!</p></div>';
                return;
            }

            resultDiv.innerHTML = '<p>Fetching recent courses...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/courses?limit=5`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Courses Retrieved!</h4>
                            <p><strong>Count:</strong> ${data.count} courses</p>
                            <pre>${JSON.stringify(data.courses.slice(0, 3), null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Courses Failed</h4>
                            <p>${data.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Courses Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.innerHTML = '<p>Testing frontend-backend connection...</p>';
            
            try {
                // Test basic connectivity
                const response = await fetch(`${API_BASE}/api/auth/admin-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@sriko.com',
                        password: 'Admin123'
                    })
                });

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Connection Successful!</h4>
                            <p><strong>Backend URL:</strong> ${API_BASE}</p>
                            <p><strong>Frontend URL:</strong> ${window.location.origin}</p>
                            <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Connection Failed</h4>
                            <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Connection Error</h4>
                        <p>${error.message}</p>
                        <p><strong>Possible issues:</strong></p>
                        <ul>
                            <li>Backend server not running</li>
                            <li>CORS configuration</li>
                            <li>Wrong API URL</li>
                            <li>Network issues</li>
                        </ul>
                    </div>
                `;
            }
        }

        function simulateDashboardLoad() {
            const resultDiv = document.getElementById('consoleResult');
            resultDiv.innerHTML = '<p>Simulating dashboard load... Check browser console for errors.</p>';
            
            // Simulate the same API calls the dashboard makes
            const token = localStorage.getItem('token') || localStorage.getItem('adminToken');
            const baseUrl = window?.configs?.apiUrl || 'http://localhost:5000';
            
            console.log('üîÑ Simulating dashboard data fetch...');
            console.log('üîë Token found:', token ? 'Yes' : 'No');
            console.log('üåê API Base URL:', baseUrl);
            
            if (!token) {
                console.error('‚ùå No token found');
                resultDiv.innerHTML = '<div class="error"><p>‚ùå No authentication token found!</p></div>';
                return;
            }
            
            // Test stats API
            fetch(`${baseUrl}/api/admin/stats`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
            })
            .then(response => {
                console.log('üìä Stats response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üìä Stats response data:', data);
                if (data.success) {
                    console.log('‚úÖ Stats loaded successfully:', data.stats);
                    resultDiv.innerHTML = '<div class="success"><p>‚úÖ Dashboard simulation successful! Check console for details.</p></div>';
                } else {
                    console.error('‚ùå Stats API returned error:', data.message);
                    resultDiv.innerHTML = '<div class="error"><p>‚ùå Stats API error: ' + data.message + '</p></div>';
                }
            })
            .catch(error => {
                console.error('‚ùå Stats fetch error:', error);
                resultDiv.innerHTML = '<div class="error"><p>‚ùå Fetch error: ' + error.message + '</p></div>';
            });
        }

        function checkPotentialIssues() {
            const issuesDiv = document.getElementById('issuesList');
            const issues = [];
            
            // Check for common issues
            if (!localStorage.getItem('token') && !localStorage.getItem('adminToken')) {
                issues.push('‚ùå No authentication token found in localStorage');
            }
            
            if (window.location.port !== '5173' && window.location.port !== '5178') {
                issues.push('‚ö†Ô∏è Frontend running on unexpected port: ' + window.location.port);
            }
            
            if (API_BASE.includes('localhost:5000')) {
                issues.push('‚ÑπÔ∏è Using localhost API URL - make sure backend is running on port 5000');
            }
            
            if (issues.length === 0) {
                issues.push('‚úÖ No obvious issues detected');
            }
            
            issuesDiv.innerHTML = '<ul>' + issues.map(issue => '<li>' + issue + '</li>').join('') + '</ul>';
        }

        // Initialize on page load
        window.onload = function() {
            updateDebugInfo();
            checkPotentialIssues();
        };
    </script>
</body>
</html>
